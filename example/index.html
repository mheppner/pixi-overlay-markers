<!DOCTYPE html>
<html style="height: 100%; margin: 0;">

<head>
    <title>Pixi Prototype</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/node_modules/leaflet/dist/leaflet.css" />
    <script src="/node_modules/leaflet/dist/leaflet.js"></script>
    <script src="/node_modules/pixi.js/dist/pixi.js"></script>
    <script src="/node_modules/leaflet-pixi-overlay/L.PixiOverlay.js"></script>
    <script src="/node_modules/pixi-overlay-markers/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>   
</head>

<body style="height: 100%; margin: 0; overflow: hidden;">
    <div style="position: absolute;
    z-index: 9999;
    top: 38px;
    left: 10px;">
        <button onClick="load()">Load Data</button>        
    </div>
    <div id="map" style="height: 100%; width: 100%;" class="cartes">
            <div class="legend geometry top center hide">
                <div class="wrapper">
                    <div class="content"></div>
                </div>
            </div>
        </div>
    
    <script>
            var map = L.map('map', { preferCanvas: true, renderer: L.canvas() }).setView([46.953387, 2.892341], 6);
            L.tileLayer('//stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
                subdomains: 'abcd',
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
                minZoom: 4,
                maxZoom: 18
            }).addTo(map);
            map.attributionControl.setPosition('bottomleft');
            map.zoomControl.setPosition('bottomright');
            
            const resources = {
                'white': 'white-marker.png'
            }

            const colors = ['#FF0000', '#0000FF', '#FFFF00', '#FFA500'];

            var self = this;
            self.pixiOverlayWrapper = new PixiOverlayWrapper(map, resources);            


            function load(){
                if(self.pixiOverlayWrapper.hasLayer('cities')){
                    self.pixiOverlayWrapper.removeLayer('cities');
                }
                const json = 'french-cities.json'; //;cities.json';
                axios.get(json).then((result) => {
                    var markers = result.data.map(marker => {
                        marker.lat = marker.latitude;
                        marker.lon = marker.longitude;
                        return marker;
                      });
                    self.pixiOverlayWrapper.createLayer('cities', markers, (marker, textures) => {
                        //use random colors...
                        const index = Math.floor(Math.random() * colors.length);                                                               
                        const hexColor = self.pixiOverlayWrapper.convertColorToHex(colors[index]);

                        let markerSprite = new PIXI.Sprite(textures['white']);                        
                        markerSprite.tint = hexColor;
                        markerSprite.originalTint = hexColor;
                        markerSprite.buttonMode = true;
                        markerSprite.interactive = true;
                        markerSprite.alpha = .8;
                        markerSprite.on('mousedown', () => {
                            alert(marker.city || marker.label);
                        });
                        markerSprite.on('mouseover', () => {
                            const hexColor = self.pixiOverlayWrapper.convertColorToHex("#FFD700");
                            markerSprite.tint = hexColor;
                            markerSprite.alpha = 1;
                        });

                        markerSprite.on('mouseout', () => {
                            markerSprite.tint = markerSprite.originalTint;
                            markerSprite.alpha = .8;
                        });
                        return markerSprite;
                    });
                    //self.pixiOverlayWrapper.createLayer('cities', markers);
                    self.pixiOverlayWrapper.render();
                });
            }
        </script>
</body>

</html>